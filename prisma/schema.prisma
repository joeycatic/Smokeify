generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  ADMIN
  STAFF
}

enum VerificationPurpose {
  SIGNUP
  NEW_DEVICE
  PASSWORD_RESET
}

enum ProductStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum ReturnStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ReviewStatus {
  APPROVED
  PENDING
  REJECTED
}

enum CustomerGroup {
  NORMAL
  VIP
  WHOLESALE
  BLOCKED
}

model User {
  id             String         @id @default(cuid())
  name           String?        @unique
  firstName      String?
  lastName       String?
  street         String?
  houseNumber    String?
  postalCode     String?
  city           String?
  country        String?
  birthDate      DateTime?
  email          String?        @unique
  emailVerified  DateTime?
  image          String?
  passwordHash   String?
  role           UserRole       @default(USER)
  customerGroup  CustomerGroup  @default(NORMAL)
  notes          String?
  newsletterOptIn Boolean       @default(false)
  newsletterOptInAt DateTime?
  accounts       Account[]
  sessions       Session[]
  wishlistItems  WishlistItem[]
  savedSetups    SavedSetup[]
  orders         Order[]
  returnRequests ReturnRequest[]
  reviews        Review[]
  devices        Device[]
  verificationCodes VerificationCode[]
  backInStockRequests BackInStockRequest[]
  newsletterSubscriber NewsletterSubscriber?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
}

model NewsletterSubscriber {
  id            String   @id @default(cuid())
  email         String   @unique
  userId        String?  @unique
  subscribedAt  DateTime @default(now())
  unsubscribedAt DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
}

model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String?
  access_token       String?
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?
  session_state      String?
  oauth_token_secret String?
  oauth_token        String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model VerificationCode {
  id        String              @id @default(cuid())
  userId    String
  email     String
  codeHash  String
  purpose   VerificationPurpose
  expiresAt DateTime
  createdAt DateTime            @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([userId])
}

model Device {
  id         String   @id @default(cuid())
  userId     String
  tokenHash  String
  lastSeenAt DateTime @default(now())
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, tokenHash])
}

model WishlistItem {
  id        String   @id @default(cuid())
  userId    String
  productId String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
}

model SavedSetup {
  id        String   @id @default(cuid())
  userId    String
  name      String?
  data      Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model BackInStockRequest {
  id           String   @id @default(cuid())
  email        String
  productId    String
  productTitle String?
  variantId    String
  variantTitle String?
  userId       String?
  notifiedAt   DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@unique([email, variantId])
  @@index([productId])
  @@index([userId])
}

model Supplier {
  id          String   @id @default(cuid())
  name        String   @unique
  contactName String?
  email       String?
  phone       String?
  website     String?
  notes       String?
  leadTimeDays Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  products    Product[]
}



model Product {
  id          String         @id @default(cuid())
  title       String
  handle      String         @unique
  description String?
  technicalDetails String?
  shortDescription String?
  seoTitle     String?
  seoDescription String?
  manufacturer String?
  supplier    String?
  supplierId  String?
  sellerName  String?
  sellerUrl   String?
  leadTimeDays Int?
  weightGrams Int?
  lengthMm    Int?
  widthMm     Int?
  heightMm    Int?
  growboxPlantCountMin Int?
  growboxPlantCountMax Int?
  growboxSize String?
  growboxConnectionDiameterMm Int[] @default([])
  lightSize String?
  airSystemDiameterMm Int?
  productGroup String?
  mainCategoryId String?
  shippingClass String?
  tags        String[]       @default([])
  status      ProductStatus  @default(DRAFT)
  bestsellerScore Float?     // computed weekly by script
  conversionRate  Float?     // set manually (0.0â€“1.0, e.g. 0.035 = 3.5%)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  variants    Variant[]
  images      ProductImage[]
  categories  ProductCategory[]
  collections ProductCollection[]
  reviews     Review[]
  inventoryAdjustments InventoryAdjustment[]
  mainCategory Category? @relation("ProductMainCategory", fields: [mainCategoryId], references: [id], onDelete: SetNull)
  supplierRef Supplier? @relation(fields: [supplierId], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([supplierId])
  @@index([mainCategoryId])
  @@index([productGroup])
  @@index([bestsellerScore])
  @@index([status, bestsellerScore])
}

model ProductImage {
  id        String   @id @default(cuid())
  productId String
  url       String
  altText   String?
  position  Int      @default(0)
  createdAt DateTime @default(now())

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId, position])
}

model Variant {
  id        String   @id @default(cuid())
  productId String
  title     String
  sku       String?  @unique
  priceCents Int
  costCents  Int      @default(0)
  lowStockThreshold Int @default(5)
  compareAtCents Int?
  position  Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product   Product          @relation(fields: [productId], references: [id], onDelete: Cascade)
  options   VariantOption[]
  inventory VariantInventory?
  inventoryAdjustments InventoryAdjustment[]

  @@index([productId, position])
}

model VariantOption {
  id        String @id @default(cuid())
  variantId String
  name      String
  value     String
  imagePosition Int?

  variant Variant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@index([variantId])
}

model VariantInventory {
  id            String   @id @default(cuid())
  variantId     String   @unique
  quantityOnHand Int     @default(0)
  reserved      Int      @default(0)
  updatedAt     DateTime @updatedAt

  variant Variant @relation(fields: [variantId], references: [id], onDelete: Cascade)
}

model InventoryAdjustment {
  id           String   @id @default(cuid())
  variantId    String
  productId    String
  orderId      String?
  quantityDelta Int
  reason       String
  createdAt    DateTime @default(now())

  variant Variant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  order   Order?  @relation(fields: [orderId], references: [id], onDelete: SetNull)

  @@index([variantId])
  @@index([productId])
  @@index([orderId])
  @@index([createdAt])
}

model Category {
  id          String   @id @default(cuid())
  name        String
  handle      String   @unique
  description String?
  parentId    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children Category[] @relation("CategoryHierarchy")
  products ProductCategory[]
  mainCategoryProducts Product[] @relation("ProductMainCategory")

  @@index([parentId])
}

model Collection {
  id          String   @id @default(cuid())
  name        String
  handle      String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  products ProductCollection[]
}

model ProductCategory {
  id         String   @id @default(cuid())
  productId  String
  categoryId String
  position   Int      @default(0)
  createdAt  DateTime @default(now())

  product  Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([productId, categoryId])
  @@index([categoryId, position])
}

model ProductCollection {
  id           String   @id @default(cuid())
  productId    String
  collectionId String
  position     Int      @default(0)
  createdAt    DateTime @default(now())

  product    Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  collection Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)

  @@unique([productId, collectionId])
  @@index([collectionId, position])
}

model Order {
  id                   String      @id @default(cuid())
  orderNumber          Int         @unique @default(autoincrement())
  userId               String?
  stripeSessionId      String      @unique
  stripePaymentIntent  String?     @unique
  paymentMethod        String?
  status               String
  paymentStatus        String
  currency             String
  amountSubtotal       Int
  amountTax            Int       @default(0)
  amountShipping       Int
  amountDiscount       Int       @default(0)
  amountTotal          Int
  discountCode         String?
  amountRefunded       Int       @default(0)
  customerEmail        String?
  shippingName         String?
  shippingLine1        String?
  shippingLine2        String?
  shippingPostalCode   String?
  shippingCity         String?
  shippingCountry      String?
  trackingCarrier      String?
  trackingNumber       String?
  trackingUrl          String?
  confirmationEmailSentAt DateTime?
  shippingEmailSentAt  DateTime?
  refundEmailSentAt    DateTime?
  createdAt            DateTime    @default(now())
  updatedAt            DateTime    @updatedAt

  user      User?      @relation(fields: [userId], references: [id], onDelete: SetNull)
  items     OrderItem[]
  returnRequests ReturnRequest[]
  inventoryAdjustments InventoryAdjustment[]

  @@index([status])
  @@index([createdAt])
  @@index([userId])
  @@index([userId, createdAt])
}

model ReturnRequest {
  id          String       @id @default(cuid())
  orderId     String
  userId      String
  status      ReturnStatus @default(PENDING)
  reason      String
  adminNote   String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  items ReturnItem[]

  @@index([orderId])
  @@index([userId])
}

model OrderItem {
  id           String   @id @default(cuid())
  orderId      String
  name         String
  quantity     Int
  unitAmount   Int
  totalAmount  Int
  baseCostAmount Int    @default(0)
  paymentFeeAmount Int  @default(0)
  adjustedCostAmount Int @default(0)
  taxAmount    Int      @default(0)
  taxRateBasisPoints Int?
  currency     String
  imageUrl     String?
  productId    String?
  variantId    String?
  options      Json?

  order        Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  returnItems  ReturnItem[]

  @@index([orderId])
}

model ReturnItem {
  id              String        @id @default(cuid())
  returnRequestId String
  orderItemId     String
  quantity        Int           @default(1)

  request  ReturnRequest @relation(fields: [returnRequestId], references: [id], onDelete: Cascade)
  orderItem OrderItem    @relation(fields: [orderItemId], references: [id], onDelete: Cascade)

  @@index([returnRequestId])
  @@index([orderItemId])
  @@unique([returnRequestId, orderItemId])
}

model Review {
  id        String       @id @default(cuid())
  productId String
  userId    String?
  guestName String?
  rating    Int
  title     String?
  body      String?
  status    ReviewStatus @default(APPROVED)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  user    User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@unique([productId, userId])
  @@index([productId, status, createdAt])
}

model RateLimit {
  key       String   @id
  count     Int
  resetAt   DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([resetAt])
}

model ProcessedWebhookEvent {
  id          String   @id @default(cuid())
  eventId     String   @unique
  type        String
  status      String   @default("processing")
  processedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([status])
}

model AdminAuditLog {
  id         String   @id @default(cuid())
  actorId    String?
  actorEmail String?
  action     String
  targetType String?
  targetId   String?
  summary    String?
  metadata   Json?
  createdAt  DateTime @default(now())

  @@index([createdAt])
  @@index([actorId])
  @@index([targetType, targetId])
}
